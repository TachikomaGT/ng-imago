/*! ng-imago - v0.1.0 - 2014-07-16
* https://github.com/panurge-ws/ng-imago
* Copyright (c) 2014 Panurge Web Studio; Licensed MIT */
!function(a){"use strict";var b={mobile_width:320,tablet_min_width:768,desktop_min_width:1280,portrait:!1,portrait_suffix:"-portrait",force_redownload:!0,loaded_class:"ng-imago-loaded",loading_class:"ng-imago-loading",error_class:"ng-imago-error"},c=!1,d=0,e=0,f=!1,g="$ngImagoImageLoaded",h="$ngImagoImageError",i="$ngImagoLoadRequest",j="$ngImagoQueueIndexComplete",k="$ngImagoLoadQueueComplete",l="$ngImagoWindowResize",m=a.module("ngImago",[]);m.provider("ngImagoProvider",[function(){this.setDefaults=function(c){if(!a.isUndefined(c)&&""!==c)for(var d in b)a.isUndefined(c[d])||(b[d]=c[d])},this.$get=a.noop}]),m.service("ngImagoAttributeParser",["$window",function(b){var c={};return c.pixelRatio=b.devicePixelRatio?b.devicePixelRatio:1,c.getUrlForAttrs=function(b,e){for(var f=[{size:"mobile",min_width:e.mobile_width},{size:"tablet",min_width:e.tablet_min_width},{size:"desktop",min_width:e.desktop_min_width},{size:"xdesktop",min_width:e.desktop_min_width+1}],g=[],h=0;h<f.length;h++)a.isUndefined(b[f[h].size])||g.push({url:b[f[h].size],min_width:f[h].min_width});if(g.length>0){g=g.sort(function(a,b){return a.min_width-b.min_width});var i="";for(i=c.parseUrl(g[g.length-1].url,b,e),h=0;h<g.length;h++)if(d<=g[h].min_width){i=c.parseUrl(g[h].url,b,e);break}return i}return""},c.parseUrl=function(b,d,e){var g="";if(b.indexOf(",")>-1){var h=b.split(",");a.forEach(h,function(a){c.pixelRatio>1&&a.indexOf("@2x")>-1?g=a:1===c.pixelRatio&&(g=a)})}else g=b;if(f&&e&&e.portrait===!0){var i=g.substr(g.lastIndexOf(".")),j=g.substr(0,g.lastIndexOf("."));g=j+e.portrait_suffix+i}return g},c}]),m.service("ngImagoService",["$rootScope",function(b){var c={};return c.queue=[],c.currIndex=-1,c.perc=0,c.perc_items=0,b.$on(g,function(a,b){c.remove(b)}),b.$on(h,function(a,b){c.remove(b)}),c.loadQueueIndex=function(a){b.$broadcast(i,a,"index")},c.loadGroup=function(a){b.$broadcast(i,a,"group")},c.loadImageById=function(a){b.$broadcast(i,a,"id")},c.add=function(a){var b=c.indexExists(a.index);b||(b={index:a.index,items:[]},c.queue.push(b)),c.itemExists(b.items,a)||(b.items.push(a),c.queue.sort(function(a,b){return a.index-b.index}))},c.indexExists=function(a,b){if(!c.queue||0===c.queue.length)return!1;for(var d=c.queue.length-1;d>=0;d--)if(c.queue[d].index===a)return b===!0?c.queue.splice(d,1):c.queue[d];return!1},c.itemExists=function(a,b,c){if(!a||0===a.length)return!1;for(var d=a.length-1;d>=0;d--)if(a[d].url===b.url)return c===!0?a.splice(d,1):a[d];return!1},c.removeQueueIndex=function(a){if(!c.queue||0===c.queue.length)return!1;for(var b=c.queue.length-1;b>=0;b--)if(c.queue[b].index===a)return c.queue.splice(b,1);return!1},c.remove=function(d){if(!a.isUndefined(d)){var e=c.indexExists(d.index),f=c.itemExists(e.items,d,!0);if(f&&e&&0===e.items.length){c.removeQueueIndex(e.index),b.$broadcast(j,c.currIndex);for(var g=0;g<c.queue.length;g++)if(c.queue[g]){c.currIndex=c.queue[g].index;break}b.$broadcast(i,c.currIndex),0===c.queue.length&&b.$broadcast(k,c.currIndex)}}},c}]),m.directive("ngImago",["ngImagoService","ngImagoAttributeParser","$rootScope","$window","$log",function(j,k,m,n,o){return{priority:950,scope:!0,restrict:"A",link:function(p,q,r){function s(){return B=k.getUrlForAttrs(r,z),""===B?(o.error("[ngImagoModule] -> no-url-for-image",r),!1):F===B?!1:B}function t(){D=!0,H="false"===r.autoLoad?!1:!0,I=a.isUndefined(r.queueIndex)?-1:Number(r.queueIndex),J=a.isUndefined(r.loadGroup)?"":r.loadGroup,s()!==!1&&(""===J&&j.add({index:I,url:B}),-1===I&&H===!0?x(!1,H):(I>-1||H===!1)&&m.$on(i,u))}function u(b,c,d){if(!a.isUndefined(c))if(I!==c&&"all"!==c||H!==!0){if(H===!1){var e=!1;d&&"group"===d&&c===J&&(e=!0),d&&"id"===d&&c===q.attr("id")&&(e=!0),d&&"index"===d&&I===c&&(e=!0),e&&x(!1,!0)}}else x(!1,!0)}function v(){A.off("load",w),A.off("error",v),C=!0,o.error("[ngImagoModule] -> error loading URL",B),A.removeClass(z.loading_class),A.addClass(z.error_class),m.$broadcast(h,{url:B,index:I})}function w(){A.off("load",w),A.off("error",v),C=!0,E=B,A.removeClass(z.loading_class),A.addClass(z.loaded_class),m.$broadcast(g,{url:B,index:I})}function x(a,b){(a!==!0||s()!==!1)&&(H||b===!0)&&(C&&(A.removeClass(z.error_class),A.removeClass(z.loaded_class)),A.addClass(z.loading_class),A.on("load",w),A.on("error",v),F=B,C=!1,y(A,z.force_redownload,B))}function y(a,b,c){b?a.attr("src",c+"?c="+Math.round(1e5*Math.random())):a.attr("src",c)}var z,A=q,B="",C=!1,D=!1,E="",F="";if(a.isUndefined(r.ngImago)||""===r.ngImago)z=b;else{z=p.$eval(r.ngImago);for(var G in b)a.isUndefined(z[G])&&(z[G]=b[G])}var H,I,J;a.isUndefined(r.src)||o.error("[ngImagoModule] -> You can't use ngImagoMng module with 'src' attribute in the <img> tag. Remove src='"+r.src+"'"),m.$on(l,function(){D&&x(!0,H||C)}),p.$watch(function(){return[q.attr("auto-load"),q.attr("queue-index")]},function(a){D&&(r.autoLoad=a[0],r.queueIndex=a[1],t())},!0),p.$watch(function(){return[q.attr("mobile"),q.attr("tablet"),q.attr("desktop"),q.attr("xdesktop")]},function(a){D?(r.mobile=a[0],r.tablet=a[1],r.desktop=a[2],r.xdesktop=a[3],x(!0,H)):t()},!0),c||(d=n.innerWidth,e=n.innerHeight,f=e>d,n.onresize=function(){d=n.innerWidth,e=n.innerHeight,f=e>d,m.$broadcast(l)},c=!0)}}}])}(window.angular);