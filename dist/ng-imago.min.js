/*! ng-imago - v0.1.0 - 2014-07-18
* https://github.com/panurge-ws/ng-imago
* Copyright (c) 2014 Panurge Web Studio; Licensed MIT */
!function(a){"use strict";function b(a,b){return window.jQuery&&window.jQuery.fn.css?$(a).css(b):window.getComputedStyle?window.getComputedStyle(a)[b]:a.currentStyle?a.currentStyle[b]:""}function c(b,c){return c&&!a.isUndefined(c[b])?c[b]:e[b]}function d(a,b,c,d,e,f){var g={width:a,height:b},h=a/b;return"fit"===e?g=d/c>b/a?{width:c,height:c/h}:{width:d*h,height:d}:"cover"===e&&(d/c>b/a?(h=a/b,g=c>d*h?{width:c,height:c/h}:{width:d*h,height:d}):g=d>c/h?{width:d*h,height:d}:{width:c,height:c/h}),f===!0&&(g.top=(d-g.height)/2,g.left=(c-g.width)/2),g}var e={portrait:!1,portrait_suffix:"-portrait",avoid_cache:!0,unbind_when_loaded:!0,loaded_class:"ng-imago-loaded",loading_class:"ng-imago-loading",error_class:"ng-imago-error",scale:"fit",center:!0,container:"parent"},f=[{attr:"small",min_width:480},{attr:"medium",min_width:768},{attr:"large",min_width:1280},{attr:"xlarge",min_width:1281}],g=!1,h=0,i=0,j=!1,k="$ngImagoImageLoaded",l="$ngImagoImageError",m="$ngImagoLoadRequest",n="$ngImagoQueueIndexComplete",o="$ngImagoLoadQueueComplete",p="$ngImagoImageResize",q="$ngImagoWindowResize",r=a.module("ngImago",[]);r.provider("ngImago",[function(){this.defaults=function(b){if(a.isUndefined(b))return e;if(""!==b)for(var c in e)a.isUndefined(b[c])||(e[c]=b[c])},this.addDefaultSize=function(a,b){f.push({attr:a,min_width:b}),f.sort(function(a,b){return a.min_width-b.min_width})},this.removeDefaultSize=function(a){for(var b=f.length-1;b>=0;b--)f[b].attr===a&&f.splice(b,1)},this.$get=a.noop}]),r.service("ngImagoAttributeParser",["$window",function(b){var d={};return d.pixelRatio=b.devicePixelRatio?b.devicePixelRatio:1,d.getUrlForAttrs=function(b,e){for(var g=[],i=0;i<f.length;i++){var j=c(f[i].attr,e)?c(f[i].attr,e):f[i].min_width;g.push({size:f[i].attr,min_width:j})}var k=[];for(i=0;i<g.length;i++)a.isUndefined(b[g[i].size])||k.push({url:b[g[i].size],min_width:g[i].min_width});if(k.length>0){k=k.sort(function(a,b){return a.min_width-b.min_width});var l="";for(l=d.parseUrl(k[k.length-1].url,b,e),i=0;i<k.length;i++)if(h<=k[i].min_width){l=d.parseUrl(k[i].url,b,e);break}return g=null,k=null,l}return""},d.parseUrl=function(b,e,f){var g="";if(b.indexOf(",")>-1){var h=b.split(",");a.forEach(h,function(a){d.pixelRatio>1&&a.indexOf("@2x")>-1?g=a:1===d.pixelRatio&&(g=a)})}else g=b;if(j&&f&&c("portrait",f)===!0){var i=g.substr(g.lastIndexOf(".")),k=g.substr(0,g.lastIndexOf("."));g=k+c("portrait_suffix",f)+i}return g},d}]),r.service("ngImagoService",["$rootScope",function(b){var c={};return c.queue=[],c.currIndex=-1,c.perc=0,c.perc_items=0,b.$on(k,function(a,b){c.remove(b)}),b.$on(l,function(a,b){c.remove(b)}),c.loadQueueIndex=function(a){b.$broadcast(m,{type:"queueIndex",index:a})},c.loadByAttribute=function(a,c){b.$broadcast(m,{type:"attr",name:a,value:c,index:0})},c.loadByClass=function(a){b.$broadcast(m,{type:"class","class":a,index:0})},c.loadImageById=function(a){b.$broadcast(m,{type:"id",id:a,index:0})},c.add=function(a){var b=c.indexExists(a.index);b||(b={index:a.index,items:[]},c.queue.push(b)),c.itemExists(b.items,a)||(console.log("add",a.url),b.items.push(a),c.queue.sort(function(a,b){return a.index-b.index}))},c.indexExists=function(a,b){if(!c.queue||0===c.queue.length)return!1;for(var d=c.queue.length-1;d>=0;d--)if(c.queue[d].index===a)return b===!0?c.queue.splice(d,1):c.queue[d];return!1},c.itemExists=function(a,b,d){if(null===a){var e=c.indexExists(b.index);e&&e.items&&e.items.length>0&&(a=e.items)}if(!a||0===a.length)return!1;for(var f=a.length-1;f>=0;f--)if(a[f].url===b.url)return d===!0?a.splice(f,1):a[f];return!1},c.removeQueueIndex=function(a){if(!c.queue||0===c.queue.length)return!1;for(var b=c.queue.length-1;b>=0;b--)if(c.queue[b].index===a)return c.queue.splice(b,1);return!1},c.remove=function(d){if(console.log("remove0"),!a.isUndefined(d)){var e=d.index,f=c.indexExists(d.index);console.log("remove1",c.queue.length,f,f.items.length,d.url);{c.itemExists(f.items,d,!0)}if(f&&0===f.items.length){c.removeQueueIndex(f.index),b.$broadcast(n,c.currIndex);for(var g=0;g<c.queue.length;g++)if(c.queue[g]&&c.queue[g].items&&c.queue[g].items.length>0){c.currIndex=c.queue[g].index;break}0===c.queue.length?b.$broadcast(o,e):b.$broadcast(m,{type:"index",index:c.currIndex})}}},c}]),r.directive("ngImago",["ngImagoService","ngImagoAttributeParser","$rootScope","$window","$log","$parse",function(b,d,e,n,o){return{priority:950,scope:!0,restrict:"A",controller:function(p,r,s){function t(a){return c(a,p.options)}function u(){p.options=a.isUndefined(s.ngImago)||""===s.ngImago?{}:p.$eval(s.ngImago)}function v(){return p.options.source_to_set=d.getUrlForAttrs(s,p.options),""===p.options.source_to_set?(o.error("[ngImagoModule] -> no-url-for-image",s),!1):p.source===p.options.source_to_set?!1:p.options.source_to_set}function w(){p.options&&p.options.source_to_set&&""!==p.options.source_to_set&&b.itemExists(null,{index:p.options.queue_index,url:p.options.source_to_set},!0),u(),D=!0,p.options.auto_load="false"===s.autoLoad?!1:!0,p.options.queue_index=a.isUndefined(s.queueIndex)?0:Number(s.queueIndex),v()!==!1&&(p.options.auto_load===!0&&b.add({index:p.options.queue_index,url:p.options.source_to_set}),p.options.queue_index<1&&p.options.auto_load===!0?y(!1,p.options.auto_load):(p.options.queue_index>0||p.options.auto_load===!1)&&(A=e.$on(m,x)))}function x(c,d){if(!p.loaded&&!a.isUndefined(d)){var e=p.options.queue_index===d.index,f=!1,g=!1;switch(d.type){case"attr":var h=s.$normalize(d.name);f=!a.isUndefined(s[h])&&s[h]===d.value;break;case"class":f=r.hasClass(d.class);break;case"id":f=r.attr("id")===d.id;break;case"queueIndex":f=p.options.queue_index===d.index}var i={index:p.options.queue_index,url:p.options.source_to_set};p.options.auto_load&&e||"queueIndex"===d.type&&p.options.queue_index===d.index?g=!0:e&&d.index>0?g=b.itemExists(null,i)!==!1:f&&0===p.options.queue_index&&(g=!0),f&&b.add(i),console.log("onLoadImgRequest",g,e,f,d,p.options),g&&y(!1,!0)}}function y(a,b){(a!==!0||v()!==!1)&&(p.options.auto_load||b===!0)&&(r.off("load",p.onImageLoad),r.off("error",p.onImageError),p.loaded&&(r.removeClass(t("error_class")),r.removeClass(t("loaded_class"))),r.addClass(t("loading_class")),r.on("load",p.onImageLoad),r.on("error",p.onImageError),p.source=p.options.source_to_set,p.loaded=!1,z(r,p.options.source_to_set,t("avoid_cache")))}function z(a,b,c){c?a.attr("src",b+"?c="+Math.round(1e5*Math.random())):a.attr("src",b)}p.loaded=!1,p.source="",p.options={};var A,B,C,D=!1;a.isUndefined(s.src)||o.error("[ngImagoModule] -> You can't use ngImagoMng module with 'src' attribute in the <img> tag. Remove src='"+s.src+"'"),p.onImageError=function(){r.off("load",p.onImageLoad),r.off("error",p.onImageError),p.loaded=!1,o.error("[ngImagoModule] -> error loading URL",p.options.source_to_set),r.removeClass(t("loading_class")),r.addClass(t("error_class")),e.$broadcast(l,{url:p.options.source_to_set,index:p.options.queue_index,elem:r}),p.$digest()},p.onImageLoad=function(){r.off("load",p.onImageLoad),r.off("error",p.onImageError),p.loaded=!0,r.removeClass(t("loading_class")),r.addClass(t("loaded_class")),p.options.unbind_when_loaded&&A&&(A(),B()),e.$broadcast(k,{url:p.options.source_to_set,index:p.options.queue_index}),p.$digest()},e.$on(q,function(){D&&y(!0,p.options.auto_load||p.loaded)}),B=p.$watch(function(){return[r.attr("auto-load"),r.attr("queue-index")]},function(a){D&&(s.autoLoad=a[0],s.queueIndex=a[1],w())},!0),C=p.$watch(function(){for(var a=[],b=0;b<f.length;b++)a.push(r.attr(f[b].attr));return a},function(a){if(D){for(var b=0;b<f.length;b++)s[f[b].attr]=a[b];y(!0,p.options.auto_load||p.loaded)}else w()},!0),g||(h=n.innerWidth,i=n.innerHeight,j=i>h,n.onresize=function(){h=n.innerWidth,i=n.innerHeight,j=i>h,e.$broadcast(q)},g=!0)},link:function(){}}}]),r.directive("imagoResize",["$window","$rootScope",function(e,f){return{require:"ngImago",controller:function(g,h,i){function j(){var a=c("scale",k),i=c("center",k);if("cover"===a||"fit"===a||i===!0){var j=c("container",k),l=h[0].width,m=h[0].height;if("parent"===j){var n=h.parent();n&&n.length>0&&n[0].width&&n[0].height&&(l=n[0].width,m=n[0].height)}else"window"===j&&(l=e.innerWidth,m=e.innerHeight);var o=d(h[0].width,h[0].height,l,m,a,i);h[0].width=o.width,h[0].height=o.height;var q=b(h[0],"position");i===!0&&h.css("fixed"===q||"absolute"===q?{top:o.top+"px",left:o.left+"px"}:{marginTop:o.top+"px",marginLeft:o.left+"px"})}f.$broadcast(p,{url:g.options.source_to_set,elem:h})}var k=a.isUndefined(i.imagoResize)?{}:g.$eval(i.imagoResize);g.$watch("loaded",function(a){a===!0&&j()}),f.$on(q,function(){g.loaded&&j()})},link:function(){}}}])}(window.angular);