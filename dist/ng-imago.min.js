/*! ng-imago - v0.1.0 - 2014-07-15
* https://github.com/panurge-ws/ng-imago
* Copyright (c) 2014 Panurge Web Studio; Licensed MIT */
!function(a){"use strict";var b={mobile_width:320,tablet_min_width:768,desktop_min_width:1280,portrait:!1,portrait_suffix:"-portrait",force_redownload:!0,loaded_class:"ng-imago-loaded",loading_class:"ng-imago-loading",error_class:"ng-imago-error"},c=!1,d=0,e=0,f=!1,g="$ngImagoImageLoaded",h="$ngImagoImageError",i="$ngImagoLoadRequest",j="$ngImagoQueueIndexComplete",k="$ngImagoLoadQueueComplete",l="$ngImagoWindowResize",m=a.module("ngImago",[]);m.provider("ngImagoProvider",[function(){this.setDefaults=function(c){if(!a.isUndefined(c)&&""!==c)for(var d in b)a.isUndefined(c[d])||(b[d]=c[d])},this.$get=a.noop}]),m.service("ngImagoAttributeParser",["$window",function(b){var c={};return c.pixelRatio=b.devicePixelRatio?b.devicePixelRatio:1,c.getUrlForAttrs=function(b,e){for(var f=[{size:"mobile",min_width:e.mobile_width},{size:"tablet",min_width:e.tablet_min_width},{size:"desktop",min_width:e.desktop_min_width},{size:"xdesktop",min_width:e.desktop_min_width+1}],g=[],h=0;h<f.length;h++)a.isUndefined(b[f[h].size])||g.push({url:b[f[h].size],min_width:f[h].min_width});if(g.length>0){g=g.sort(function(a,b){return a.min_width-b.min_width});var i="";for(i=c.parseUrl(g[g.length-1].url,b,e),h=0;h<g.length;h++)if(d<=g[h].min_width){i=c.parseUrl(g[h].url,b,e);break}return i}return""},c.parseUrl=function(b,d,e){var g="";if(b.indexOf(",")>-1){var h=b.split(",");a.forEach(h,function(a){c.pixelRatio>1&&a.indexOf("@2x")>-1?g=a:1===c.pixelRatio&&(g=a)})}else g=b;if(f&&e&&e.portrait===!0){var i=g.substr(g.lastIndexOf(".")),j=g.substr(0,g.lastIndexOf("."));g=j+e.portrait_suffix+i}return g},c}]),m.service("ngImagoService",["$rootScope",function(b){var c={};return c.queue=[],c.currIndex=-1,c.perc=0,c.perc_items=0,b.$on(g,function(a,b){c.remove(b)}),b.$on(h,function(a,b){c.remove(b)}),c.loadQueueIndex=function(a){b.$broadcast(i,a,"index")},c.loadGroup=function(a){b.$broadcast(i,a,"group")},c.loadImageById=function(a){b.$broadcast(i,a,"id")},c.add=function(a){var b=c.indexExists(a.index);b||(b={index:a.index,items:[]},c.queue.push(b)),c.itemExists(b.items,a)||(b.items.push(a),c.queue.sort(function(a,b){return a.index-b.index}))},c.indexExists=function(a,b){if(!c.queue||0===c.queue.length)return!1;for(var d=c.queue.length-1;d>=0;d--)if(c.queue[d].index===a)return b===!0?c.queue.splice(d,1):c.queue[d];return!1},c.itemExists=function(a,b,c){if(!a||0===a.length)return!1;for(var d=a.length-1;d>=0;d--)if(a[d].url===b.url)return c===!0?a.splice(d,1):a[d];return!1},c.removeQueueIndex=function(a){if(!c.queue||0===c.queue.length)return!1;for(var b=c.queue.length-1;b>=0;b--)if(c.queue[b].index===a)return c.queue.splice(b,1);return!1},c.remove=function(d){if(!a.isUndefined(d)){var e=c.indexExists(d.index),f=c.itemExists(e.items,d,!0);if(f&&e&&0===e.items.length){c.removeQueueIndex(e.index),b.$broadcast(j,c.currIndex);for(var g=0;g<c.queue.length;g++)if(c.queue[g]){c.currIndex=c.queue[g].index;break}b.$broadcast(i,c.currIndex),0===c.queue.length&&b.$broadcast(k,c.currIndex)}}},c}]),m.directive("ngImago",["ngImagoService","ngImagoAttributeParser","$rootScope","$window","$log",function(j,k,m,n,o){return{priority:950,scope:!0,restrict:"A",link:function(p,q,r){function s(){return A=k.getUrlForAttrs(r,y),""===A?void o.error("[ngImagoModule] -> no-url-for-image",r):void(E!==A&&(""!==E&&j.remove({index:H,url:E}),j.add({index:H,url:A}),E=A,-1===H&&G===!0?w(!1,G):(H>-1||G===!1)&&m.$on(i,t),C=!0))}function t(b,c,d){if(!a.isUndefined(c))if(H!==c&&"all"!==c||G!==!0){if(G===!1){var e=!1;d&&"group"===d&&c===I&&(e=!0),d&&"id"===d&&c===q.attr("id")&&(e=!0),d&&"index"===d&&H===c&&(e=!0),e&&w(!1,!0)}}else w(!1,!0)}function u(){z.off("load",v),z.off("error",u),B=!0,o.error("[ngImagoModule] -> error loading URL",A),z.removeClass(y.loading_class),z.addClass(y.error_class),m.$broadcast(h,{url:A,index:H})}function v(){z.off("load",v),z.off("error",u),B=!0,D=A,z.removeClass(y.loading_class),z.addClass(y.loaded_class),m.$broadcast(g,{url:A,index:H})}function w(a,b){if(a===!0){if(A=k.getUrlForAttrs(r,y),""===A)return void o.error("[ngImagoModule] -> no-url-for-image",r);if(E===A)return}(G||b===!0)&&(B&&(z.removeClass(y.error_class),z.removeClass(y.loaded_class)),z.addClass(y.loading_class),z.on("load",v),z.on("error",u),E=A,B=!1,x(z,y.force_redownload,A))}function x(a,b,c){b?a.attr("src",c+"?c="+Math.round(1e5*Math.random())):a.attr("src",c)}var y,z=q,A="",B=!1,C=!1,D="",E="";if(a.isUndefined(r.ngImago)||""===r.ngImago)y=b;else{y=p.$eval(r.ngImago);for(var F in b)a.isUndefined(y[F])&&(y[F]=b[F])}var G=p.autoLoad===!1?!1:!0,H=a.isUndefined(r.queueIndex)?-1:r.queueIndex,I=a.isUndefined(r.loadGroup)?"default":r.loadGroup;a.isUndefined(r.src)||o.error("[ngImagoModule] -> You can't use ngImagoMng module with 'src' attribute in the <img> tag. Remove src='"+r.src+"'"),m.$on(l,function(){C&&w(!0,G||B)}),p.$watch(function(){return[q.attr("mobile"),q.attr("tablet"),q.attr("desktop"),q.attr("xdesktop"),q.attr("queue-index")]},function(a){C?(r.mobile=a[0],r.tablet=a[1],r.desktop=a[2],r.xdesktop=a[3],r.queueIndex=a[4],w(!0,G)):s()},!0),c||(d=n.innerWidth,e=n.innerHeight,f=e>d,n.onresize=function(){d=n.innerWidth,e=n.innerHeight,f=e>d,m.$broadcast(l)},c=!0)}}}])}(window.angular);