/*! ng-imago - v0.1.0 - 2014-07-19
* https://github.com/panurge-ws/ng-imago
* Copyright (c) 2014 Panurge Web Studio; Licensed MIT */
!function(a){"use strict";function b(a,b){return window.jQuery&&window.jQuery.fn.css?$(a).css(b):window.getComputedStyle?window.getComputedStyle(a)[b]:a.currentStyle?a.currentStyle[b]:""}function c(b,c){return c&&!a.isUndefined(c[b])?c[b]:e[b]}function d(a,b,c,d,e,f){var g={width:a,height:b},h=a/b;return"fit"===e?g=d/c>b/a?{width:c,height:c/h}:{width:d*h,height:d}:"cover"===e&&(d/c>b/a?(h=a/b,g=c>d*h?{width:c,height:c/h}:{width:d*h,height:d}):g=d>c/h?{width:d*h,height:d}:{width:c,height:c/h}),f===!0&&(g.top=(d-g.height)/2,g.left=(c-g.width)/2),g}var e={portrait:!0,portrait_suffix:"-portrait",avoid_cache:!0,unbind_when_loaded:!0,loaded_class:"ng-imago-loaded",loading_class:"ng-imago-loading",error_class:"ng-imago-error",scale:"fit",center:!0,container:"parent"},f=[{attr:"small",min_width:480},{attr:"medium",min_width:768},{attr:"large",min_width:1280},{attr:"xlarge",min_width:1281}];if(a.isUndefined(matchMedia))throw"matchMedia does not exist. Please use a polyfill";var g="$ngImagoImageLoaded",h="$ngImagoImageError",i="$ngImagoLoadRequest",j="$ngImagoQueueIndexComplete",k="$ngImagoLoadQueueComplete",l="$ngImagoImageResize",m="$ngImagoWindowResize",n=a.module("ngImago",[]);n.value("defaultSizes",[{attr:"small",query:"only screen and (max-width: 480px)"},{attr:"medium",query:"only screen and (min-width:481px) and (max-width: 768px)"},{attr:"large",query:"only screen and (min-width:769px) and (max-width: 1280px)"},{attr:"xlarge",query:"only screen and (min-width:1281px)"}]),n.value("utilsQueries",{retina:"only screen and (-webkit-min-device-pixel-ratio: 2), only screen and (min--moz-device-pixel-ratio: 2), only screen and (-o-min-device-pixel-ratio: 2/1), only screen and (min-device-pixel-ratio: 2), only screen and (min-resolution: 192dpi), only screen and (min-resolution: 2dppx)",portrait:"only screen and (orientation: portrait)","default":"only screen and (min-width: 1px)"}),n.provider("ngImago",[function(){this.defaults=function(b){if(a.isUndefined(b))return e;if(""!==b)for(var c in e)a.isUndefined(b[c])||(e[c]=b[c])},this.addDefaultSize=function(a,b){f.push({attr:a,min_width:b}),f.sort(function(a,b){return a.min_width-b.min_width})},this.changeDefaultSize=function(a,b){for(var c=f.length-1;c>=0;c--)f[c].attr===a&&(f[c].attr=b)},this.removeDefaultSize=function(a){for(var b=f.length-1;b>=0;b--)if(f[b].attr===a){f.splice(b,1);break}},this.$get=a.noop}]),n.service("ngImagoAttributeParser",["$window","$log","$rootScope","defaultSizes","utilsQueries",function(b,c,d,e,f){var g={};g.listeners=[],g.mediaQueries=[],g.calculateUrl=function(a,b){var d=g.getUrlForAttrs(a,b);return""===d?(c.error("[ngImagoModule] -> no-url-for-image",a),!1):d},g.getUrlForAttrs=function(b,c){var d=null,e=null;for(var f in b)if(!a.isUndefined(f)&&!a.isUndefined(b[f])){var k=f.replace("Portrait",""),l=f.indexOf("Portrait")>-1,m=j(k);if(null!=m){var n="";n=a.isUndefined(c[f])?m.query:c[f],console.log(n);var o=i(n);o===!1&&(o=h(n)),l?o.matches&&g.portraitQuery.matches?d=b[f]:null==d&&(e=b[f]):o.matches?d=b[f]:null==d&&(e=b[f])}}return null===d&&null!==e&&(d=e),null===d||a.isUndefined(d)?"":g.parseAttr(d,b,c)},g.mediaQueryHandler=function(a){(a.matches||a.media.indexOf("portrait")>-1)&&d.$broadcast(m)};var h=function(a){var b=matchMedia(a);return b.addListener(g.mediaQueryHandler),g.mediaQueries[a]=b,g.mediaQueries[a]},i=function(b){return a.isUndefined(g.mediaQueries[b])?!1:g.mediaQueries[b]},j=function(a){for(var b=0;b<e.length;b++)if(e[b].attr===a)return e[b];return null};return g.parseAttr=function(b){var c="";if(b.indexOf(",")>-1){var d=b.split(",");a.forEach(d,function(a){g.isRetina===!0&&a.indexOf("@2x")>-1?c=a:g.isRetina===!1&&(c=a)})}else c=b;return c},g.isRetina=matchMedia(f.retina).matches,g.portraitQuery=h(f.portrait),g.defaultQuery=h(f.default),g}]),n.service("ngImagoService",["$rootScope",function(b){var c={};return c.queue=[],c.currIndex=-1,c.perc=0,c.perc_items=0,b.$on(g,function(a,b,d){c.remove(b,d)}),b.$on(h,function(a,b){c.remove(b)}),c.loadQueueIndex=function(a){b.$broadcast(i,{type:"queueIndex",index:a})},c.loadByAttribute=function(a,c){b.$broadcast(i,{type:"attr",name:a,value:c,index:0})},c.loadByClass=function(a){b.$broadcast(i,{type:"class","class":a,index:0})},c.loadImageById=function(a){b.$broadcast(i,{type:"id",id:a,index:0})},c.add=function(a){var b=c.indexExists(a.index);b||(b={index:a.index,items:[]},c.queue.push(b)),c.itemExists(b.items,a)||(b.items.push(a),c.queue.sort(function(a,b){return a.index-b.index}))},c.indexExists=function(a,b){if(!c.queue||0===c.queue.length)return!1;for(var d=c.queue.length-1;d>=0;d--)if(c.queue[d].index===a)return b===!0?c.queue.splice(d,1):c.queue[d];return!1},c.itemExists=function(a,b,d){if(null===a){var e=c.indexExists(b.index);e&&e.items&&e.items.length>0&&(a=e.items)}if(!a||0===a.length)return!1;for(var f=a.length-1;f>=0;f--)if(a[f].url===b.url)return d===!0?a.splice(f,1):a[f];return!1},c.removeQueueIndex=function(a){if(!c.queue||0===c.queue.length)return!1;for(var b=c.queue.length-1;b>=0;b--)if(c.queue[b].index===a)return c.queue.splice(b,1);return!1},c.remove=function(d,e){if(!a.isUndefined(d)){{var f=d.index,g=c.indexExists(d.index);c.itemExists(g.items,d,!0)}if(g&&0===g.items.length){c.removeQueueIndex(g.index),b.$broadcast(j,f,d,e);for(var h=0;h<c.queue.length;h++)if(c.queue[h]&&c.queue[h].items&&c.queue[h].items.length>0){c.currIndex=c.queue[h].index;break}0===c.queue.length?b.$broadcast(k,f,d,e):b.$broadcast(i,{type:"index",index:c.currIndex})}}},c}]),n.directive("ngImago",["ngImagoService","ngImagoAttributeParser","$rootScope","$window","$log","$parse",function(b,d,e,j,k){return{priority:950,scope:!0,restrict:"A",controller:function(j,l,n){function o(a){return c(a,j.options)}function p(){j.options=a.isUndefined(n.ngImago)||""===n.ngImago?{}:j.$eval(n.ngImago)}function q(){return j.options.source_to_set=d.getUrlForAttrs(n,j.options),""===j.options.source_to_set?(k.error("[ngImagoModule] -> no-url-for-image",n),!1):j.source===j.options.source_to_set?!1:j.options.source_to_set}function r(){j.options&&j.options.source_to_set&&""!==j.options.source_to_set&&b.itemExists(null,{index:j.options.queue_index,url:j.options.source_to_set},!0),p(),j.initialized=!0,j.options.auto_load="false"===n.autoLoad?!1:!0,j.options.queue_index=a.isUndefined(n.queueIndex)?0:Number(n.queueIndex),j.options.source_to_set=d.calculateUrl(n,j.options),j.options.source_to_set!==!1&&j.source!==j.options.source_to_set&&(j.options.auto_load===!0&&b.add({index:j.options.queue_index,url:j.options.source_to_set}),j.options.queue_index<1&&j.options.auto_load===!0?t(!1,j.options.auto_load):(j.options.queue_index>0||j.options.auto_load===!1)&&(v=e.$on(i,s)))}function s(c,d){if(!j.loaded&&!a.isUndefined(d)){var e=j.options.queue_index===d.index,f=!1,g=!1;switch(d.type){case"attr":var h=n.$normalize(d.name);f=!a.isUndefined(n[h])&&n[h]===d.value;break;case"class":f=l.hasClass(d.class);break;case"id":f=l.attr("id")===d.id;break;case"queueIndex":f=j.options.queue_index===d.index}var i={index:j.options.queue_index,url:j.options.source_to_set};j.options.auto_load&&e||"queueIndex"===d.type&&j.options.queue_index===d.index?g=!0:e&&d.index>0?g=b.itemExists(null,i)!==!1:f&&0===j.options.queue_index&&(g=!0),f&&b.add(i),g&&t(!1,!0)}}function t(a,b){(a!==!0||q()!==!1)&&(j.options.auto_load||b===!0)&&(l.off("load",j.onImageLoad),l.off("error",j.onImageError),j.loaded&&(l.removeClass(o("error_class")),l.removeClass(o("loaded_class"))),l.addClass(o("loading_class")),l.on("load",j.onImageLoad),l.on("error",j.onImageError),j.source=j.options.source_to_set,j.loaded=!1,u(l,j.options.source_to_set,o("avoid_cache")))}function u(a,b,c){c?a.attr("src",b+"?c="+Math.round(1e5*Math.random())):a.attr("src",b)}j.loaded=!1,j.initialized=!1,j.source="",j.options={};var v,w,x;a.isUndefined(n.src)||k.error("[ngImagoModule] -> You can't use ngImagoMng module with 'src' attribute in the <img> tag. Remove src='"+n.src+"'"),j.onImageError=function(){l.off("load",j.onImageLoad),l.off("error",j.onImageError),j.loaded=!1,k.error("[ngImagoModule] -> error loading URL",j.options.source_to_set),l.removeClass(o("loading_class")),l.addClass(o("error_class")),e.$broadcast(h,{url:j.options.source_to_set,index:j.options.queue_index}),j.$digest()},j.onImageLoad=function(){l.off("load",j.onImageLoad),l.off("error",j.onImageError),j.loaded=!0,l.removeClass(o("loading_class")),l.addClass(o("loaded_class")),j.options.unbind_when_loaded&&v&&(v(),w()),e.$broadcast(g,{url:j.options.source_to_set,index:j.options.queue_index},l),j.$digest()},e.$on(m,function(){j.initialized&&t(!0,j.options.auto_load||j.loaded)}),w=j.$watch(function(){return[l.attr("auto-load"),l.attr("queue-index")]},function(a){j.initialized&&(n.autoLoad=a[0],n.queueIndex=a[1],r())},!0),x=j.$watch(function(){for(var a=[],b=0;b<f.length;b++)a.push(l.attr(f[b].attr));return a},function(a){if(j.initialized){for(var b=0;b<f.length;b++)n[f[b].attr]=a[b];t(!0,j.options.auto_load||j.loaded)}else r()},!0)},link:function(){}}}]),n.directive("imagoResize",["$window","$rootScope",function(e,f){return{require:"ngImago",controller:function(g,h,i){function j(){var a=c("scale",k),i=c("center",k);if("cover"===a||"fit"===a||i===!0){var j=c("container",k),m=h[0].width,n=h[0].height;if("parent"===j){var o=h.parent();o&&o.length>0&&o[0].width&&o[0].height&&(m=o[0].width,n=o[0].height)}else"window"===j&&(m=e.innerWidth,n=e.innerHeight);var p=d(h[0].width,h[0].height,m,n,a,i);h[0].width=p.width,h[0].height=p.height;var q=b(h[0],"position");i===!0&&h.css("fixed"===q||"absolute"===q?{top:p.top+"px",left:p.left+"px"}:{marginTop:p.top+"px",marginLeft:p.left+"px"})}f.$broadcast(l,{url:g.options.source_to_set,elem:h})}var k=a.isUndefined(i.imagoResize)?{}:g.$eval(i.imagoResize);g.$watch("loaded",function(a){a===!0&&j()}),f.$on(m,function(){g.loaded&&j()})},link:function(){}}}])}(window.angular);