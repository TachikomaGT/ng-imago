/*! ng-imago - v0.1.0 - 2014-07-23
* https://github.com/panurge-ws/ng-imago
* Copyright (c) 2014 Panurge Web Studio; Licensed MIT */
!function(a){"use strict";function b(a,b){return window.jQuery&&window.jQuery.fn.css?$(a).css(b):window.getComputedStyle?window.getComputedStyle(a)[b]:a.currentStyle?a.currentStyle[b]:""}function c(b,c){return c&&!a.isUndefined(c[b])?c[b]:e[b]}function d(a,b,c,d,e,f){var g={width:a,height:b},h=a/b;return"fit"===e?g=d/c>b/a?{width:c,height:c/h}:{width:d*h,height:d}:"cover"===e&&(d/c>b/a?(h=a/b,g=c>d*h?{width:c,height:c/h}:{width:d*h,height:d}):g=d>c/h?{width:d*h,height:d}:{width:c,height:c/h}),f===!0&&(g.top=(d-g.height)/2,g.left=(c-g.width)/2),g}var e={avoid_cache:!0,unbind_when_loaded:!0,loaded_class:"ng-imago-loaded",loading_class:"ng-imago-loading",error_class:"ng-imago-error",scale:"fit",center:!0,container:"parent"},f=[{attr:"default",query:"only screen and (min-width: 1px)"},{attr:"small",query:"only screen and (min-width: 480px)"},{attr:"medium",query:"only screen and (min-width: 768px)"},{attr:"large",query:"only screen and (min-width: 1280px)"},{attr:"xlarge",query:"only screen and (min-width: 1440px)"}],g={retina:"only screen and (-webkit-min-device-pixel-ratio: 2), only screen and (min--moz-device-pixel-ratio: 2), only screen and (-o-min-device-pixel-ratio: 2/1), only screen and (min-device-pixel-ratio: 2), only screen and (min-resolution: 192dpi), only screen and (min-resolution: 2dppx)",portrait:"only screen and (orientation: portrait)"},h=!1;if(a.isUndefined(matchMedia))throw"matchMedia does not exist. Please use a polyfill";var i="$ngImagoImageLoaded",j="$ngImagoImageError",k="$ngImagoLoadRequest",l="$ngImagoQueueIndexComplete",m="$ngImagoLoadQueueComplete",n="$ngImagoImageResize",o="$ngImagoWindowResize",p="$ngImagoMediaQueryChanged",q=a.module("ngImago",[]);q.provider("ngImago",[function(){this.defaultsSettings=function(b){if(a.isUndefined(b))return e;if(""!==b)for(var c in e)a.isUndefined(b[c])||(e[c]=b[c])},this.defaultsSizes=function(b){if(a.isUndefined(b))return f;if(""!==b)for(var c in f)a.isUndefined(b[c])||(f[c]=b[c])},this.addDefaultSize=function(a,b){f.push({attr:a,query:b})},this.changeDefaultSize=function(a,b){for(var c=f.length-1;c>=0;c--)f[c].attr===a&&(f[c].attr=b)},this.removeDefaultSize=function(a){for(var b=f.length-1;b>=0;b--)if(f[b].attr===a){f.splice(b,1);break}},this.$get=a.noop}]),q.service("ngImagoAttributeParser",["$window","$log","$rootScope",function(b,c,d){var e={};e.mediaQueries=[],e.calculateUrl=function(a,b){var d=e.getUrlForAttrs(a,b);return""===d?(c.error("[ngImagoModule] -> no-url-for-image",a),!1):d},e.getUrlForAttrs=function(b,c){var d=null,f=null;for(var g in b)if(!a.isUndefined(g)&&!a.isUndefined(b[g])){var k=g.replace("Portrait",""),l=g.indexOf("Portrait")>-1,m=j(k);if(null!=m){var n="";n=a.isUndefined(c[g])?m.query:c[g];var o=i(n);o===!1&&(o=h(n)),l?o.matches&&e.portraitQuery.matches?d=b[g]:null==d&&(f=b[g]):o.matches?d=b[g]:null==d&&(f=b[g])}}return null===d&&null!==f&&(d=f),null===d||a.isUndefined(d)?"":e.parseAttr(d,b,c)},e.mediaQueryHandler=function(){d.$broadcast(p)};var h=function(a){var b=matchMedia(a);return b.addListener(e.mediaQueryHandler),e.mediaQueries[a]=b,e.mediaQueries[a]},i=function(b){return a.isUndefined(e.mediaQueries[b])?!1:e.mediaQueries[b]},j=function(a){for(var b=0;b<f.length;b++)if(f[b].attr===a)return f[b];return null};return e.parseAttr=function(b){var c="";if(b.indexOf(",")>-1){var d=b.split(",");a.forEach(d,function(a){e.isRetina===!0&&a.indexOf("@2x")>-1?c=a:e.isRetina===!1&&(c=a)})}else c=b;return c},e.isRetina=matchMedia(g.retina).matches,e.portraitQuery=h(g.portrait),e}]),q.service("ngImagoService",["$rootScope",function(a){var b={};return b.loadQueueIndex=function(b){a.$broadcast(k,{type:"queueIndex",index:b})},b.loadByAttribute=function(b,c){a.$broadcast(k,{type:"attr",name:b,value:c,index:0})},b.loadByClass=function(b){a.$broadcast(k,{type:"class","class":b,index:0})},b.loadImageById=function(b){a.$broadcast(k,{type:"id",id:b,index:0})},b}]),q.service("ngImagoQueue",["$rootScope",function(b){var c={};return c.queue=[],c.currIndex=-1,c.perc=0,c.perc_items=0,b.$on(i,function(a,b,d){c.remove(b,d)}),b.$on(j,function(a,b){c.remove(b)}),c.add=function(a){var b=c.indexExists(a.index);b||(b={index:a.index,items:[]},c.queue.push(b)),c.itemExists(b.items,a)||(b.items.push(a),c.queue.sort(function(a,b){return a.index-b.index}))},c.indexExists=function(a,b){if(!c.queue||0===c.queue.length)return!1;for(var d=c.queue.length-1;d>=0;d--)if(c.queue[d].index===a)return b===!0?c.queue.splice(d,1):c.queue[d];return!1},c.itemExists=function(a,b,d){if(null===a){var e=c.indexExists(b.index);e&&e.items&&e.items.length>0&&(a=e.items)}if(!a||0===a.length)return!1;for(var f=a.length-1;f>=0;f--)if(a[f].url===b.url)return d===!0?a.splice(f,1):a[f];return!1},c.removeQueueIndex=function(a){if(!c.queue||0===c.queue.length)return!1;for(var b=c.queue.length-1;b>=0;b--)if(c.queue[b].index===a)return c.queue.splice(b,1);return!1},c.remove=function(d,e){if(!a.isUndefined(d)){{var f=d.index,g=c.indexExists(d.index);c.itemExists(g.items,d,!0)}if(g&&0===g.items.length){c.removeQueueIndex(g.index),b.$broadcast(l,f,d,e);for(var h=0;h<c.queue.length;h++)if(c.queue[h]&&c.queue[h].items&&c.queue[h].items.length>0){c.currIndex=c.queue[h].index;break}0===c.queue.length?b.$broadcast(m,f,d,e):b.$broadcast(k,{type:"index",index:c.currIndex})}}},c}]),q.directive("ngImago",["ngImagoQueue","ngImagoAttributeParser","$rootScope","$log",function(b,d,e,g){return{priority:950,scope:!0,restrict:"EA",controller:["$scope","$element","$attrs","$transclude",function(h,l,m){function n(a){return c(a,h.options)}function o(){h.options=a.isUndefined(m.ngImago)||""===m.ngImago?{}:h.$eval(m.ngImago)}function q(){return h.options.source_to_set=d.getUrlForAttrs(m,h.options),""===h.options.source_to_set?(g.error("[ngImagoModule] -> no-url-for-image",m),!1):h.source===h.options.source_to_set?!1:h.options.source_to_set}function r(){h.options&&h.options.source_to_set&&""!==h.options.source_to_set&&b.itemExists(null,{index:h.options.queue_index,url:h.options.source_to_set},!0),o(),h.initialized=!0,h.options.auto_load="false"===m.autoLoad?!1:!0,h.options.queue_index=a.isUndefined(m.queueIndex)?0:Number(m.queueIndex),h.options.source_to_set=d.calculateUrl(m,h.options),h.options.source_to_set!==!1&&h.source!==h.options.source_to_set&&(h.options.auto_load===!0&&b.add({index:h.options.queue_index,url:h.options.source_to_set}),h.options.queue_index<1&&h.options.auto_load===!0?v(!1,h.options.auto_load):(h.options.queue_index>0||h.options.auto_load===!1)&&(y=e.$on(k,s)))}function s(c,d){if(!h.loaded&&!a.isUndefined(d)){var e=h.options.queue_index===d.index,f=!1,g=!1;switch(d.type){case"attr":var i=m.$normalize(d.name);f=!a.isUndefined(m[i])&&m[i]===d.value;break;case"class":f=l.hasClass(d.class);break;case"id":f=l.attr("id")===d.id;break;case"queueIndex":f=h.options.queue_index===d.index}var j={index:h.options.queue_index,url:h.options.source_to_set};h.options.auto_load&&e||"queueIndex"===d.type&&h.options.queue_index===d.index?g=!0:e&&d.index>0?g=b.itemExists(null,j)!==!1:f&&0===h.options.queue_index&&(g=!0),f&&b.add(j),g&&v(!1,!0)}}function t(){x.off("load",u),x.off("error",t),h.loaded=!1,g.error("[ngImagoModule] -> error loading URL",h.options.source_to_set),l.removeClass(n("loading_class")),l.addClass(n("error_class")),e.$broadcast(j,{url:h.options.source_to_set,index:h.options.queue_index},l),h.$digest()}function u(){x.off("load",u),x.off("error",t),h.loaded=!0,l.removeClass(n("loading_class")),l.addClass(n("loaded_class")),n("unbind_when_loaded")&&y&&(y(),z(),A()),e.$broadcast(i,{url:h.options.source_to_set,index:h.options.queue_index},l),h.$digest()}function v(a,b){(a!==!0||q()!==!1)&&(h.options.auto_load||b===!0)&&(x.off("load",u),x.off("error",t),h.loaded&&(l.removeClass(n("error_class")),l.removeClass(n("loaded_class"))),l.addClass(n("loading_class")),x.on("load",u),x.on("error",t),h.source=h.options.source_to_set,h.loaded=!1,w(h.options.source_to_set,n("avoid_cache")))}function w(a,b){var c=a;b&&(c+="?c="+(1e5*Math.random()).toString()),"IMG"===h.elementType?l.attr("src",c):l.css("background-image","url("+c+")")}h.loaded=!1,h.initialized=!1,h.source="",h.options={},h.elementType="",h.load=function(a){h.initialized||r(),v(a,!0)};var x;"IMG"===l[0].tagName.toUpperCase()?(h.elementType="IMG",x=l):(h.elementType="NO-IMG",x=a.element(new Image));var y,z,A;a.isUndefined(m.src)||g.error("[ngImagoModule] -> You can't use ngImagoMng module with 'src' attribute in the <img> tag. Remove src='"+m.src+"'"),e.$on(p,function(){h.initialized&&v(!0,h.options.auto_load||h.loaded)}),z=h.$watch(function(){return[l.attr("auto-load"),l.attr("queue-index")]},function(a){h.initialized&&(m.autoLoad=a[0],m.queueIndex=a[1],r())},!0),A=h.$watch(function(){for(var a=[],b=0;b<f.length;b++)a.push(l.attr(f[b].attr));return a},function(a){if(h.initialized){for(var b=0;b<f.length;b++)m[f[b].attr]=a[b];v(!0,h.options.auto_load||h.loaded)}else r()},!0)}]}}]),q.directive("imagoResize",["$window","$rootScope",function(e,f){return{require:"ngImago",controller:["$scope","$element","$attrs",function(g,i,j){function k(){var a=c("scale",l),h=c("center",l);if("cover"===a||"fit"===a||h===!0){var j=c("container",l),k=i[0].width,m=i[0].height;if("parent"===j){var o=i.parent();if(o&&o.length>0){var p=parseInt(b(o[0],"width"),10),q=parseInt(b(o[0],"height"),10);k=p,m=q}}else"window"===j&&(k=e.innerWidth,m=e.innerHeight);var r=d(i[0].width,i[0].height,k,m,a,h);i[0].width=r.width,i[0].height=r.height;var s=b(i[0],"position");h===!0&&i.css("fixed"===s||"absolute"===s?{top:r.top+"px",left:r.left+"px"}:{marginTop:r.top+"px",marginLeft:r.left+"px"})}f.$broadcast(n,{url:g.options.source_to_set,elem:i})}var l=a.isUndefined(j.imagoResize)?{}:g.$eval(j.imagoResize);return"NO-IMG"===g.elementType?(i.css("background-size",c("scale",l)),void(c("center",l)===!0&&i.css("background-position","center center"))):(g.$watch("loaded",function(a){a===!0&&k()}),f.$on(o,function(){g.loaded&&k()}),void(h||(e.onresize=function(){f.$broadcast(o)},h=!0)))}]}}])}(window.angular);