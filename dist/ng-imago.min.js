/*! ng-imago - v0.1.1 - 2014-09-03
* https://github.com/panurge-ws/ng-imago
* Copyright (c) 2014 Panurge Web Studio; Licensed MIT */
!function(a){"use strict";function b(a,b){return window.jQuery&&window.jQuery.fn.css?$(a).css(b):window.getComputedStyle?window.getComputedStyle(a)[b]:a.currentStyle?a.currentStyle[b]:""}function c(b,c){return c&&!a.isUndefined(c[b])?c[b]:e[b]}function d(a,b,c,d,e,f){var g={width:a,height:b},h=a/b;return"contain"===e?g=d/c>b/a?{width:c,height:c/h}:{width:d*h,height:d}:"cover"===e&&(d/c>b/a?(h=a/b,g=c>d*h?{width:c,height:c/h}:{width:d*h,height:d}):g=d>c/h?{width:d*h,height:d}:{width:c,height:c/h}),f===!0&&(g.top=(d-g.height)/2,g.left=(c-g.width)/2),g}var e={avoid_cache:!0,unbind_when_loaded:!0,loaded_class:"ng-imago-loaded",loading_class:"ng-imago-loading",error_class:"ng-imago-error",scale:"contain",center:!0,container:"parent",parent_classes:!0},f=[{attr:"default",query:"only screen and (min-width: 1px)"},{attr:"small",query:"only screen and (min-width: 480px)"},{attr:"medium",query:"only screen and (min-width: 768px)"},{attr:"large",query:"only screen and (min-width: 1280px)"},{attr:"xlarge",query:"only screen and (min-width: 1440px)"}],g={retina:"only screen and (-webkit-min-device-pixel-ratio: 2), only screen and (min--moz-device-pixel-ratio: 2), only screen and (-o-min-device-pixel-ratio: 2/1), only screen and (min-device-pixel-ratio: 2), only screen and (min-resolution: 192dpi), only screen and (min-resolution: 2dppx)",portrait:"only screen and (orientation: portrait)"},h=!1;if(a.isUndefined(matchMedia))throw"matchMedia does not exist. Please use a polyfill";var i="$ngImagoImageLoaded",j="$ngImagoImageError",k="$ngImagoLoadRequest",l="$ngImagoQueueIndexComplete",m="$ngImagoLoadQueueComplete",n="$ngImagoImageResize",o="$ngImagoWindowResize",p="$ngImagoMediaQueryChanged",q=a.module("ngImago",[]);q.provider("ngImago",[function(){this.defaultsSettings=function(b){if(a.isUndefined(b))return e;if(""!==b)for(var c in e)a.isUndefined(b[c])||(e[c]=b[c])},this.defaultsSizes=function(b){if(a.isUndefined(b))return f;if(""!==b)for(var c in f)a.isUndefined(b[c])||(f[c]=b[c])},this.addDefaultSize=function(a,b){f.push({attr:a,query:b})},this.changeDefaultSize=function(a,b){for(var c=f.length-1;c>=0;c--)f[c].attr===a&&(f[c].attr=b)},this.removeDefaultSize=function(a){for(var b=f.length-1;b>=0;b--)if(f[b].attr===a){f.splice(b,1);break}},this.$get=a.noop}]),q.service("ngImagoAttributeParser",["$window","$log","$rootScope",function(b,d,e){var h={};h.mediaQueries=[],h.calculateUrl=function(a,b){var e=h.getUrlForSources(a,b);return""===e?(d.error("[ngImagoModule] -> no-url-for-image",a),!1):(c("avoid_cache",b)===!0&&(e+=e.indexOf("?")>-1?"&c="+(1e5*Math.random()).toString():"?c="+(1e5*Math.random()).toString()),e)},h.getUrlForSources=function(b,c){var d=null,e=null;for(var f in b)if(!a.isUndefined(b[f])){var g=f.replace("Portrait",""),l=f.indexOf("Portrait")>-1,m=k(g);if(null!=m){var n="";n=a.isUndefined(c[f])?m.query:c[f];var o=j(n);o===!1&&(o=i(n)),l?o.matches&&h.portraitQuery.matches?d=b[f]:null==d&&(e=b[f]):o.matches?d=b[f]:null==d&&(e=b[f])}}return null===d&&null!==e&&(d=e),null===d||a.isUndefined(d)?"":h.parseAttr(d,b,c)},h.mediaQueryHandler=function(a){e.$broadcast(p,a)};var i=function(a){var b=matchMedia(a);return b.addListener(h.mediaQueryHandler),h.mediaQueries[a]=b,h.mediaQueries[a]},j=function(b){return a.isUndefined(h.mediaQueries[b])?!1:h.mediaQueries[b]},k=function(a){for(var b=0;b<f.length;b++)if(f[b].attr===a)return f[b];return null};return h.parseAttr=function(b){var c="";if(b.indexOf(",")>-1){var d=b.split(",");a.forEach(d,function(a){h.isRetina===!0&&a.indexOf("@2x")>-1?c=a:h.isRetina===!1&&(c=a)})}else c=b;return c},h.isRetina=matchMedia(g.retina).matches,h.portraitQuery=i(g.portrait),h}]),q.service("ngImagoService",["$rootScope",function(a){var b={};return b.loadQueueIndex=function(b){a.$broadcast(k,{type:"queueIndex",index:b})},b.loadByAttribute=function(b,c){a.$broadcast(k,{type:"attr",name:b,value:c,index:0})},b.loadByClass=function(b){a.$broadcast(k,{type:"class","class":b,index:0})},b.loadImageById=function(b){a.$broadcast(k,{type:"id",id:b,index:0})},b}]),q.service("ngImagoQueue",["$rootScope",function(b){var c={};return c.queue=[],c.currIndex=-1,c.perc=0,c.perc_items=0,b.$on(i,function(a,b,d){c.remove(b,d)}),b.$on(j,function(a,b){c.remove(b)}),c.add=function(a){var b=c.indexExists(a.index);b||(b={index:a.index,items:[]},c.queue.push(b)),c.itemExists(b.items,a)||(b.items.push(a),c.queue.sort(function(a,b){return a.index-b.index}))},c.indexExists=function(a,b){if(!c.queue||0===c.queue.length)return!1;for(var d=c.queue.length-1;d>=0;d--)if(c.queue[d].index===a)return b===!0?c.queue.splice(d,1):c.queue[d];return!1},c.itemExists=function(a,b,d){if(null===a){var e=c.indexExists(b.index);e&&e.items&&e.items.length>0&&(a=e.items)}if(!a||0===a.length)return!1;for(var f=a.length-1;f>=0;f--)if(a[f].url===b.url)return d===!0?a.splice(f,1):a[f];return!1},c.removeQueueIndex=function(a){if(!c.queue||0===c.queue.length)return!1;for(var b=c.queue.length-1;b>=0;b--)if(c.queue[b].index===a)return c.queue.splice(b,1);return!1},c.remove=function(d,e){if(!a.isUndefined(d)){{var f=d.index,g=c.indexExists(d.index);c.itemExists(g.items,d,!0)}if(g&&0===g.items.length){c.removeQueueIndex(g.index),b.$broadcast(l,f,d,e);for(var h=0;h<c.queue.length;h++)if(c.queue[h]&&c.queue[h].items&&c.queue[h].items.length>0){c.currIndex=c.queue[h].index;break}0===c.queue.length?b.$broadcast(m,f,d,e):b.$broadcast(k,{type:"index",index:c.currIndex})}}},c}]),q.directive("ngImago",["ngImagoQueue","ngImagoAttributeParser","$rootScope","$log",function(b,d,e,g){return{scope:{},restrict:"EA",controller:["$scope","$element","$attrs",function(h,l,m){function n(){h.options&&h.options.source_to_set&&""!==h.options.source_to_set&&b.itemExists(null,{index:h.options.queue_index,url:h.options.source_to_set},!0),o(),h.initialized=!0,h.options.auto_load="false"===m.autoLoad?!1:!0,h.options.queue_index=a.isUndefined(m.queueIndex)?0:Number(m.queueIndex),h.options.source_to_set=d.calculateUrl(h.sourcesSet,h.options),h.options.source_to_set!==!1&&h.source!==h.options.source_to_set&&(h.options.auto_load===!0&&b.add({index:h.options.queue_index,url:h.options.source_to_set}),h.options.queue_index<1&&h.options.auto_load===!0?u(!1,h.options.auto_load):(h.options.queue_index>0||h.options.auto_load===!1)&&(y=e.$on(k,r)))}function o(){h.options=a.isUndefined(m.override)?a.isUndefined(m.ngImago)||""===m.ngImago?{}:h.$eval(m.ngImago):""===m.override?{}:h.$eval(m.override)}function q(){return h.options.source_to_set=d.calculateUrl(h.sourcesSet,h.options),""===h.options.source_to_set?(g.error("[ngImagoModule] -> no-url-for-image",m),!1):h.source===h.options.source_to_set?!1:h.options.source_to_set}function r(c,d){if(!h.loaded&&!a.isUndefined(d)){var e=h.options.queue_index===d.index,f=!1,g=!1;switch(d.type){case"attr":var i=m.$normalize(d.name);f=!a.isUndefined(m[i])&&m[i]===d.value;break;case"class":f=l.hasClass(d.class);break;case"id":f=l.attr("id")===d.id;break;case"queueIndex":f=h.options.queue_index===d.index}var j={index:h.options.queue_index,url:h.options.source_to_set};h.options.auto_load&&e||"queueIndex"===d.type&&h.options.queue_index===d.index?g=!0:e&&d.index>0?g=b.itemExists(null,j)!==!1:f&&0===h.options.queue_index&&(g=!0),f&&b.add(j),g&&u(!1,!0)}}function s(){x.off("load",t),x.off("error",s),h.loaded=!1,g.error("[ngImagoModule] -> error loading URL",h.options.source_to_set);var a=l.parent();w("parent_classes")&&a&&(a.removeClass(w("loading_class")),a.addClass(w("error_class"))),l.removeClass(w("loading_class")),l.addClass(w("error_class")),e.$broadcast(j,{url:h.options.source_to_set,index:h.options.queue_index},l),h.$apply()}function t(){x.off("load",t),x.off("error",s),h.loaded=!0;var a=l.parent();w("parent_classes")&&a&&(a.removeClass(w("loading_class")),a.addClass(w("loaded_class"))),l.removeClass(w("loading_class")),l.addClass(w("loaded_class")),w("unbind_when_loaded")&&y&&(y(),z(),A()),"IMG"!==h.elementType&&l.css("background-image","url("+x.attr("src")+")"),e.$broadcast(i,{url:h.options.source_to_set,index:h.options.queue_index},l),h.$apply()}function u(a,b){if((a!==!0||q()!==!1)&&(h.options.auto_load||b===!0)){x.off("load",t),x.off("error",s);var c=l.parent();h.loaded&&(w("parent_classes")&&c&&(c.removeClass(w("error_class")),c.addClass(w("loaded_class"))),l.removeClass(w("error_class")),l.removeClass(w("loaded_class"))),w("parent_classes")&&c&&c.addClass(w("loading_class")),l.addClass(w("loading_class")),x.on("load",t),x.on("error",s),h.source=h.options.source_to_set,h.loaded=!1,v(h.options.source_to_set)}}function v(a){x.attr("src",a)}function w(a){return c(a,h.options)}h.loaded=!1,h.initialized=!1,h.source="",h.options={},h.sourcesSet={},h.elementType="",h.load=function(a){h.initialized||n(),u(a,!0)},this.isLoaded=function(){return h.loaded},this.getOptions=function(){return h.options},this.getSource=function(){return h.source},this.getSourcesSet=function(){return h.sourcesSet},this.getElementType=function(){return h.elementType};var x,y,z,A;"IMG"===l[0].tagName.toUpperCase()?(h.elementType="IMG",x=l):(h.elementType="NO-IMG",x=a.element(new Image)),a.isUndefined(m.src)||g.error("[ngImagoModule] -> You can't use ngImagoMng module with 'src' attribute in the <img> tag. Remove src='"+m.src+"'"),e.$on(p,function(){h.initialized&&u(!0,h.options.auto_load||h.loaded)}),z=h.$watch(function(){return[l.attr("auto-load"),l.attr("queue-index"),l.attr("override")]},function(a){m.autoLoad=a[0],m.queueIndex=a[1],m.override=a[2],h.initialized&&n()},!0),A=h.$watch(function(){for(var a=[l.attr("sources")],b=0;b<f.length;b++)a.push(l.attr(f[b].attr));return a},function(b){if(a.isUndefined(b[0]))for(var c=0;c<f.length;c++)h.sourcesSet[f[c].attr]=b[c+1];else h.sourcesSet=h.$eval(b[0]);h.initialized?u(!0,h.options.auto_load||h.loaded):n()},!0)}]}}]),q.directive("imagoResize",["$window","$rootScope",function(e,f){return{transclude:!0,restrict:"A",require:"ngImago",link:function(g,i,j,k){function l(){var a=c("scale",m),g=c("center",m);if("cover"===a||"contain"===a||g===!0){var h=c("container",m),j=i[0].width,l=i[0].height;if("parent"===h){var o=i.parent();if(o&&o.length>0){var p=parseInt(b(o[0],"width"),10),q=parseInt(b(o[0],"height"),10);j=p,l=q}}else"window"===h&&(j=e.innerWidth,l=e.innerHeight);var r=d(i[0].width,i[0].height,j,l,a,g);i[0].width=r.width,i[0].height=r.height;var s=b(i[0],"position");g===!0&&i.css("fixed"===s||"absolute"===s?{top:r.top+"px",left:r.left+"px"}:{marginTop:r.top+"px",marginLeft:r.left+"px"})}f.$broadcast(n,{url:k.getSource(),elem:i})}var m=a.isUndefined(j.imagoResize)?{}:g.$eval(j.imagoResize);g.$watch(function(){return k.isLoaded()},function(a){if(a===!0)if("NO-IMG"===k.getElementType()){var b=c("scale",m),d=c("center",m);("cover"===b||"contain"===b)&&i.css("background-size",b),d===!0&&i.css("background-position","center center")}else l()}),f.$on(o,function(){k.isLoaded()&&l()}),h||(e.onresize=function(){f.$broadcast(o)},h=!0)}}}])}(window.angular);