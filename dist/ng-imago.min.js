/*! ng-imago - v0.1.0 - 2014-07-22
* https://github.com/panurge-ws/ng-imago
* Copyright (c) 2014 Panurge Web Studio; Licensed MIT */
!function(a){"use strict";function b(a,b){return window.jQuery&&window.jQuery.fn.css?$(a).css(b):window.getComputedStyle?window.getComputedStyle(a)[b]:a.currentStyle?a.currentStyle[b]:""}function c(b,c){return c&&!a.isUndefined(c[b])?c[b]:e[b]}function d(a,b,c,d,e,f){var g={width:a,height:b},h=a/b;return"fit"===e?g=d/c>b/a?{width:c,height:c/h}:{width:d*h,height:d}:"cover"===e&&(d/c>b/a?(h=a/b,g=c>d*h?{width:c,height:c/h}:{width:d*h,height:d}):g=d>c/h?{width:d*h,height:d}:{width:c,height:c/h}),f===!0&&(g.top=(d-g.height)/2,g.left=(c-g.width)/2),g}var e={avoid_cache:!0,unbind_when_loaded:!1,loaded_class:"ng-imago-loaded",loading_class:"ng-imago-loading",error_class:"ng-imago-error",scale:"fit",center:!0,container:"parent"},f=[{attr:"default",query:"only screen and (min-width: 1px)"},{attr:"small",query:"only screen and (min-width: 480px)"},{attr:"medium",query:"only screen and (min-width: 768px)"},{attr:"large",query:"only screen and (min-width: 1280px)"},{attr:"xlarge",query:"only screen and (min-width:1281px)"}],g=!1;if(a.isUndefined(matchMedia))throw"matchMedia does not exist. Please use a polyfill";var h="$ngImagoImageLoaded",i="$ngImagoImageError",j="$ngImagoLoadRequest",k="$ngImagoQueueIndexComplete",l="$ngImagoLoadQueueComplete",m="$ngImagoImageResize",n="$ngImagoWindowResize",o="$ngImagoMediaQueryChanged",p=a.module("ngImago",[]);p.value("utilsQueries",{retina:"only screen and (-webkit-min-device-pixel-ratio: 2), only screen and (min--moz-device-pixel-ratio: 2), only screen and (-o-min-device-pixel-ratio: 2/1), only screen and (min-device-pixel-ratio: 2), only screen and (min-resolution: 192dpi), only screen and (min-resolution: 2dppx)",portrait:"only screen and (orientation: portrait)"}),p.provider("ngImago",[function(){this.defaults=function(b){if(a.isUndefined(b))return e;if(""!==b)for(var c in e)a.isUndefined(b[c])||(e[c]=b[c])},this.addDefaultSize=function(a,b){f.push({attr:a,query:b})},this.changeDefaultSize=function(a,b){for(var c=f.length-1;c>=0;c--)f[c].attr===a&&(f[c].attr=b)},this.removeDefaultSize=function(a){for(var b=f.length-1;b>=0;b--)if(f[b].attr===a){f.splice(b,1);break}},this.$get=a.noop}]),p.service("ngImagoAttributeParser",["$window","$log","$rootScope","utilsQueries",function(b,c,d,e){var g={};g.mediaQueries=[],g.calculateUrl=function(a,b){var d=g.getUrlForAttrs(a,b);return""===d?(c.error("[ngImagoModule] -> no-url-for-image",a),!1):d},g.getUrlForAttrs=function(b,c){var d=null,e=null;for(var f in b)if(!a.isUndefined(f)&&!a.isUndefined(b[f])){var k=f.replace("Portrait",""),l=f.indexOf("Portrait")>-1,m=j(k);if(null!=m){var n="";n=a.isUndefined(c[f])?m.query:c[f];var o=i(n);o===!1&&(o=h(n)),l?o.matches&&g.portraitQuery.matches?d=b[f]:null==d&&(e=b[f]):o.matches?d=b[f]:null==d&&(e=b[f])}}return null===d&&null!==e&&(d=e),null===d||a.isUndefined(d)?"":g.parseAttr(d,b,c)},g.mediaQueryHandler=function(){d.$broadcast(o)};var h=function(a){var b=matchMedia(a);return b.addListener(g.mediaQueryHandler),g.mediaQueries[a]=b,g.mediaQueries[a]},i=function(b){return a.isUndefined(g.mediaQueries[b])?!1:g.mediaQueries[b]},j=function(a){for(var b=0;b<f.length;b++)if(f[b].attr===a)return f[b];return null};return g.parseAttr=function(b){var c="";if(b.indexOf(",")>-1){var d=b.split(",");a.forEach(d,function(a){g.isRetina===!0&&a.indexOf("@2x")>-1?c=a:g.isRetina===!1&&(c=a)})}else c=b;return c},g.isRetina=matchMedia(e.retina).matches,g.portraitQuery=h(e.portrait),g}]),p.service("ngImagoService",["$rootScope",function(b){var c={};return c.queue=[],c.currIndex=-1,c.perc=0,c.perc_items=0,b.$on(h,function(a,b,d){c.remove(b,d)}),b.$on(i,function(a,b){c.remove(b)}),c.loadQueueIndex=function(a){b.$broadcast(j,{type:"queueIndex",index:a})},c.loadByAttribute=function(a,c){b.$broadcast(j,{type:"attr",name:a,value:c,index:0})},c.loadByClass=function(a){b.$broadcast(j,{type:"class","class":a,index:0})},c.loadImageById=function(a){b.$broadcast(j,{type:"id",id:a,index:0})},c.add=function(a){var b=c.indexExists(a.index);b||(b={index:a.index,items:[]},c.queue.push(b)),c.itemExists(b.items,a)||(b.items.push(a),c.queue.sort(function(a,b){return a.index-b.index}))},c.indexExists=function(a,b){if(!c.queue||0===c.queue.length)return!1;for(var d=c.queue.length-1;d>=0;d--)if(c.queue[d].index===a)return b===!0?c.queue.splice(d,1):c.queue[d];return!1},c.itemExists=function(a,b,d){if(null===a){var e=c.indexExists(b.index);e&&e.items&&e.items.length>0&&(a=e.items)}if(!a||0===a.length)return!1;for(var f=a.length-1;f>=0;f--)if(a[f].url===b.url)return d===!0?a.splice(f,1):a[f];return!1},c.removeQueueIndex=function(a){if(!c.queue||0===c.queue.length)return!1;for(var b=c.queue.length-1;b>=0;b--)if(c.queue[b].index===a)return c.queue.splice(b,1);return!1},c.remove=function(d,e){if(!a.isUndefined(d)){{var f=d.index,g=c.indexExists(d.index);c.itemExists(g.items,d,!0)}if(g&&0===g.items.length){c.removeQueueIndex(g.index),b.$broadcast(k,f,d,e);for(var h=0;h<c.queue.length;h++)if(c.queue[h]&&c.queue[h].items&&c.queue[h].items.length>0){c.currIndex=c.queue[h].index;break}0===c.queue.length?b.$broadcast(l,f,d,e):b.$broadcast(j,{type:"index",index:c.currIndex})}}},c}]),p.directive("ngImago",["ngImagoService","ngImagoAttributeParser","$rootScope","$window","$log","$parse",function(b,d,e,g,k){return{priority:950,scope:!0,restrict:"A",controller:function(g,l,m){function n(a){return c(a,g.options)}function p(){g.options=a.isUndefined(m.ngImago)||""===m.ngImago?{}:g.$eval(m.ngImago)}function q(){return g.options.source_to_set=d.getUrlForAttrs(m,g.options),""===g.options.source_to_set?(k.error("[ngImagoModule] -> no-url-for-image",m),!1):g.source===g.options.source_to_set?!1:g.options.source_to_set}function r(){g.options&&g.options.source_to_set&&""!==g.options.source_to_set&&b.itemExists(null,{index:g.options.queue_index,url:g.options.source_to_set},!0),p(),g.initialized=!0,g.options.auto_load="false"===m.autoLoad?!1:!0,g.options.queue_index=a.isUndefined(m.queueIndex)?0:Number(m.queueIndex),g.options.source_to_set=d.calculateUrl(m,g.options),g.options.source_to_set!==!1&&g.source!==g.options.source_to_set&&(g.options.auto_load===!0&&b.add({index:g.options.queue_index,url:g.options.source_to_set}),g.options.queue_index<1&&g.options.auto_load===!0?t(!1,g.options.auto_load):(g.options.queue_index>0||g.options.auto_load===!1)&&(v=e.$on(j,s)))}function s(c,d){if(!g.loaded&&!a.isUndefined(d)){var e=g.options.queue_index===d.index,f=!1,h=!1;switch(d.type){case"attr":var i=m.$normalize(d.name);f=!a.isUndefined(m[i])&&m[i]===d.value;break;case"class":f=l.hasClass(d.class);break;case"id":f=l.attr("id")===d.id;break;case"queueIndex":f=g.options.queue_index===d.index}var j={index:g.options.queue_index,url:g.options.source_to_set};g.options.auto_load&&e||"queueIndex"===d.type&&g.options.queue_index===d.index?h=!0:e&&d.index>0?h=b.itemExists(null,j)!==!1:f&&0===g.options.queue_index&&(h=!0),f&&b.add(j),h&&t(!1,!0)}}function t(a,b){(a!==!0||q()!==!1)&&(g.options.auto_load||b===!0)&&(l.off("load",g.onImageLoad),l.off("error",g.onImageError),g.loaded&&(l.removeClass(n("error_class")),l.removeClass(n("loaded_class"))),l.addClass(n("loading_class")),l.on("load",g.onImageLoad),l.on("error",g.onImageError),g.source=g.options.source_to_set,g.loaded=!1,u(l,g.options.source_to_set,n("avoid_cache")))}function u(a,b,c){c?a.attr("src",b+"?c="+Math.round(1e5*Math.random())):a.attr("src",b)}g.loaded=!1,g.initialized=!1,g.source="",g.options={};var v,w,x;a.isUndefined(m.src)||k.error("[ngImagoModule] -> You can't use ngImagoMng module with 'src' attribute in the <img> tag. Remove src='"+m.src+"'"),g.onImageError=function(){l.off("load",g.onImageLoad),l.off("error",g.onImageError),g.loaded=!1,k.error("[ngImagoModule] -> error loading URL",g.options.source_to_set),l.removeClass(n("loading_class")),l.addClass(n("error_class")),e.$broadcast(i,{url:g.options.source_to_set,index:g.options.queue_index}),g.$digest()},g.onImageLoad=function(){l.off("load",g.onImageLoad),l.off("error",g.onImageError),g.loaded=!0,l.removeClass(n("loading_class")),l.addClass(n("loaded_class")),n("unbind_when_loaded")&&v&&(v(),w(),x()),e.$broadcast(h,{url:g.options.source_to_set,index:g.options.queue_index},l),g.$digest()},e.$on(o,function(){g.initialized&&t(!0,g.options.auto_load||g.loaded)}),w=g.$watch(function(){return[l.attr("auto-load"),l.attr("queue-index")]},function(a){g.initialized&&(m.autoLoad=a[0],m.queueIndex=a[1],r())},!0),x=g.$watch(function(){for(var a=[],b=0;b<f.length;b++)a.push(l.attr(f[b].attr));return a},function(a){if(g.initialized){for(var b=0;b<f.length;b++)m[f[b].attr]=a[b];t(!0,g.options.auto_load||g.loaded)}else r()},!0)}}}]),p.directive("imagoResize",["$window","$rootScope",function(e,f){return{require:"ngImago",controller:function(h,i,j){function k(){var a=c("scale",l),g=c("center",l);if("cover"===a||"fit"===a||g===!0){var j=c("container",l),k=i[0].width,n=i[0].height;if("parent"===j){var o=i.parent();o&&o.length>0&&o[0].width&&o[0].height&&(k=o[0].width,n=o[0].height)}else"window"===j&&(k=e.innerWidth,n=e.innerHeight);var p=d(i[0].width,i[0].height,k,n,a,g);i[0].width=p.width,i[0].height=p.height;var q=b(i[0],"position");g===!0&&i.css("fixed"===q||"absolute"===q?{top:p.top+"px",left:p.left+"px"}:{marginTop:p.top+"px",marginLeft:p.left+"px"})}f.$broadcast(m,{url:h.options.source_to_set,elem:i})}var l=a.isUndefined(j.imagoResize)?{}:h.$eval(j.imagoResize);h.$watch("loaded",function(a){a===!0&&k()}),f.$on(n,function(){h.loaded&&k()}),g||(e.onresize=function(){f.$broadcast(n)},g=!0)}}}])}(window.angular);